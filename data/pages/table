<html>
<head>
<title>CA Web Interface</title>
<script language="javascript" type="text/javascript" src="jquery.js"></script>

<script type="text/javascript">

        function loadPopup(){
            if(popupStatus==0){
                $("#container").css({
                    "opacity": "0.5"
                });
                $("#container").fadeIn("slow");
                $("#popupContact").fadeIn("slow");
                popupStatus = 1;
            }
        }
        
        function disablePopup(){
            if(popupStatus==1){
                $("#container").css({
                    "opacity": "1"
                });
                $("#popupContact").fadeOut("slow");
                popupStatus = 0;
            }
        }
        
        function centerPopup(){
            var windowWidth = document.documentElement.clientWidth;
            var windowHeight = document.documentElement.clientHeight;
            var popupHeight = $("#popupContact").height();
            var popupWidth = $("#popupContact").width();
            $("#popupContact").css({
                "position": "absolute",
                "top": windowHeight/2-popupHeight/2,
                "left": windowWidth/2-popupWidth/2
            });
        }

    $(".document").ready(function () {
        popupStatus = 0;
        $("#popupContactClose").click( function() {
                disablePopup();
                times = [];
        });
        $('#popupl').click( function() {
            centerPopup();
            loadPopup();
        });
        $.post("api",{ data: ["crtget"] }, function( data ) {
            var params = {};
            var result = {};
            $.each( data, function ( key, val ) {
                if ( val[0] == 'R' ) {
                    result[key] = [];
                    result[key][0] = val[3];
                    result[key][1] = val[0];
                }
                else if ( val[0] == 'V' ) {
                    result[key] = [];
                    result[key][0] = val[2];
                    result[key][1] = val[0];
                }
                $.each( val, function( ky, subj ) {
                    if ( ky == val.length-1) {
                        if ( val[0] == 'R' ) {
                            result[key][2] = [];
                        }
                        else if ( val[0] == 'V' ) {
                            result[key][2] = [];
                        }
                        $.each( subj, function( k, v ) {
                            var pr = v.split('=')[0];
                            var vl = v.split('=')[1];
                            if ( val[0] == 'R' ) {
                                result[key][2][pr] = vl;
                            }
                            else if ( val[0] == 'V' ) {
                                result[key][2][pr] = vl;
                            }
                            //console.log(params);
                        });
                    }

                });
                if ( result[key][1] == 'V' ) {
                    $('#certs').append('<tr><td>'+result[key][0]+"</td><td>"+result[key][1]+"</td><td>C="+result[key][2]['C']+", CN="+result[key][2]['CN']+", O="+result[key][2]['O']+", OU="+result[key][2]['OU']+"</td><td><button id="+result[key][0]+">Revoke</button><button id=dw"+result[key][2]['CN']+">Download</button></td></tr>");
                    $('#'+result[key][0]).click( function () {
                        $.post("api",{ data: ["crtrev",result[key][0]] })
                    });
                    $('#dw'+result[key][2]['CN']).click( function () {
                        window.open("/arc/"+result[key][2]['CN']+".tar","_blank")
                    });
                }
                else {
                    $('#certs').append('<tr><td>'+result[key][0]+"</td><td>"+result[key][1]+"</td><td>C="+result[key][2]['C']+", CN="+result[key][2]['CN']+", O="+result[key][2]['O']+", OU="+result[key][2]['OU']+"</td></td></tr>");
                }
            });
        console.log(result);    
        });
        $('#crtgen').click( function () {
            cn = $('#cn').val()
            tp = $('input[name="tp"]:checked').val();
            $.post("api",{ data: ["crtgen", cn, '0', tp] })
        });
        $('#crtgencsr').click( function () {
            cn = $('#cn').val()
            csr = $('#csr').val()
            tp = $('input[name="tp"]:checked').val();
            $.post("api",{ data: ["crtgen", cn, '1', tp, csr] })
        });
    });
    
</script>
</head>
<body>
<div style='positon:absolute;width:100%;height:60%' id='container'>
    <div style='position:relative;width:60%;height:100%;margin:auto' id='frtbl'>
        <center><table border='1'>
            <tbody id='certs'>
                <tr>
                    <td>S/N</td>
                    <td>State</td>
                    <td>Options</td>
                    <td>Action</td>
                </tr>
            </tbody>
        </table></center>
    </div>
    <div style='position:relative;width:60%;height:100%;margin:auto' id='but'>
    <button id="popupl">Add</button>
    </div>
</div>
<div id="popupContact" style="display: none; border: solid 1px black;background-color: #FFFFFF;">
<div style="height: 470px; width: 340px;margin: 10px;">
<div style='position:relative;width:100%;height:5%;' align='right'>
<button id="popupContactClose">X</button>
</div>
<div style='position:relative;width:100%;height:10%'>
Canonical Name (certificate name for CSR): <input id='cn'> 
<button id='crtgen'>Generate New</button>
</div>
<div style='position:relative;width:100%;height:10%'>
<input type='radio' value='srv' name='tp'>Server</input><input type='radio' value='clnt' name='tp' checked>Client</input>
</div>
<div style='position:relative;width:100%;height:75%'>
Certificate request:<br><textarea id='csr' rows='20' cols='40'></textarea>
<button id='crtgencsr'>Generate New</button>
</div>
</div>
</div>
</body>